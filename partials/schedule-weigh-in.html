<main>
    
    
    <h1 class="name-data"></h1>
    <span id="result"></span>
    <div class="columns">
        
        <section class="flex-2">
            
            <h3>Schedule a new weigh-in</h3>
             <p class="readable">
                
                When you schedule this weigh-in, an e-mail will <em>immediately</em> be dispatched to each of the participants containing the link they must use to record their weight. 
                <br />
            </p>
            <p>
                
                <b>This means you are sending an e-mail to <span class="count-data"></span> participants.</b>
                <br />
                <br />
                
            </p>
            <form id="weigh-in" action="challenge-weigh-ins">
                
                <input type="hidden" name="id" class="value-id-data" />
                <label>
                    
                    <span class="label-text">Weigh-in date</span>
                    <input type="date" name="when" required />
                    
                </label>
                <label>
                    
                    <span class="label-text">Deadline (end of)</span>
                    <input type="date" name="deadline" required />
                    <button data-add="1" type="button" class="deadline-calc">Day after</button>
                    <button data-add="2" type="button" class="deadline-calc">Two days after</button>
                    
                </label>
                <input type="submit" value="Schedule!" />
                
            </form>
        
        </section>
        <section>
            
            <h3>Already scheduled</h3>
            <table>
                
                <thead>
                
                    <th></th>
                    <th>Weigh-in date</th>
                    <th></th>
                    
                </thead>
                <tbody id="scheduled">
                    
                    
                </tbody>
                
            </table>
            
            
        </section>
        
    </div>
    <template id="scheduled-template">
        
        <tr>
            
            <td class="index-data"></td>
            <td class="when-data"></td>
            <td><a class="href-id-data href-when-data" href="/challenge-weigh-in?cid={id}&when={when}">Detail</a></td>
            
        </tr>
        
    </template>
    
</main>
<script>

    /* global attempt, challenges, populate, urlParams, parseISODate, incrementDateByDays, ISODate, moment, entemplate, orDefault */
    attempt( function() {
        
        var challenge = challenges.find( c => c.id === urlParams.cid );
        if ( !challenge ) { throw new Error( "Challenge not found" ); }
        
        var weighIns = orDefault( "weighins-" + challenge.id, {} );
        
        populate( ".name-data", challenge.name );
        populate( ".value-id-data", function( ele ) { ele.value = challenge.id; } );
        populate( ".count-data", Object.keys( challenge.participants || {} ).length );
        var index = 0;
        var whens = Object.keys( weighIns ).sort().filter( function( x ) { return !x.startsWith( "__" ); } );
        entemplate( "#scheduled-template", "#scheduled", whens, function( populateNode, value ) {
            
            var niceWhen = moment( parseISODate( value ) ).format( "dddd, Do of MMMM" );
            populateNode( ".href-id-data", function( ele ) { ele.href = ele.href.replace( "{id}", challenge.id ); } );
            populateNode( ".href-when-data", function( ele ) { ele.href = ele.href.replace( "{when}", value ); } );
            populateNode( ".index-data", ++index );
            populateNode( ".when-data", niceWhen );
            
        } );
        
        
        var form = document.querySelector( "#weigh-in" );
        form[ "when" ].addEventListener( "change", function() {
            
            form[ "deadline" ].value = form[ "when" ].value;
            
        } );
        for( var button of document.querySelectorAll( ".deadline-calc" ) )
            button.addEventListener( "click", function( e ) {
                
                var add = e.target.dataset.add;
                var when = parseISODate( form[ "when" ].value );
                var deadline = incrementDateByDays( when, add );
                form[ "deadline" ].value = ISODate( deadline );
                
            } );
        document.querySelector( "#weigh-in" ).addEventListener( "submit", function( e ) {
            
            var when = parseISODate( form[ "when" ].value );
            var deadline = parseISODate( form[ "deadline" ].value );
            var result = document.querySelector( "#result" );
            if ( deadline < when ) { 
                
                e.preventDefault();
                result.textContent = "Oops! Deadline must be after the weigh-in date";
                
            }
            if ( new Date() > deadline ) { 
                
                e.preventDefault();
                result.textContent = "Oops! Deadline should be a future date";
                
            }
            
        } );
        
    } );
        

</script>